<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Lập Hóa Đơn</title>
        <link rel="stylesheet" href="/static/css/main.css" />

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Cập nhật thể loại và đơn giá khi chọn sách
                document
                    .querySelectorAll(".book-select")
                    .forEach(function (selectElement) {
                        selectElement.addEventListener("change", function () {
                            var bookID = this.value;
                            var row = this.closest("tr");
                            var categoryInput = row.querySelector(
                                'input[name="category[]"]'
                            );
                            var priceInput = row.querySelector(
                                'input[name="price[]"]'
                            );

                            // Gửi yêu cầu AJAX để lấy thông tin sách
                            fetch("/get_book_info/" + bookID)
                                .then((response) => response.json())
                                .then((data) => {
                                    if (data) {
                                        categoryInput.value = data.genre; // Cập nhật thể loại
                                        priceInput.value = data.Selling_Price; // Cập nhật đơn giá
                                        calculateTotal();
                                    }
                                })
                                .catch((error) =>
                                    console.error("Error:", error)
                                );
                        });
                    });

                // Thêm dòng vào bảng
                document
                    .getElementById("add-row")
                    .addEventListener("click", function () {
                        var table = document.querySelector(
                            "#invoice-table tbody"
                        );
                        var rowCount = table.rows.length + 1;
                        var newRow = table.insertRow();

                        newRow.innerHTML = `
                            <td>${rowCount}</td>
                            <td>
                                <select name="bookID[]" class="book-select">
                                    {% for book in books %}
                                    <option value="{{ book[0] }}">{{ book[1] }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td><input type="text" name="category[]" readonly /></td>
                            <td><input type="number" name="quantity[]" min="1" onchange="calculateTotal()" /></td>
                            <td><input type="number" name="price[]" readonly /></td>
                        `;

                        // Gắn sự kiện cho dropdown mới
                        newRow
                            .querySelector(".book-select")
                            .addEventListener("change", function () {
                                var bookID = this.value;
                                var row = this.closest("tr");
                                var categoryInput = row.querySelector(
                                    'input[name="category[]"]'
                                );
                                var priceInput = row.querySelector(
                                    'input[name="price[]"]'
                                );

                                // Gửi yêu cầu AJAX để lấy thông tin sách
                                fetch("/get_book_info/" + bookID)
                                    .then((response) => response.json())
                                    .then((data) => {
                                        if (data) {
                                            categoryInput.value = data.genre; // Cập nhật thể loại
                                            priceInput.value =
                                                data.Selling_Price; // Cập nhật đơn giá
                                            calculateTotal();
                                        }
                                    })
                                    .catch((error) =>
                                        console.error("Error:", error)
                                    );
                            });
                    });
                // Tính tổng tiền của hóa đơn
                // Cập nhật giá trị khi người dùng thay đổi số lượng hoặc giá
                document
                    .querySelectorAll(
                        'input[name="quantity[]"], input[name="price[]"]'
                    )
                    .forEach(function (inputElement) {
                        inputElement.addEventListener("input", function () {
                            calculateTotal(); // Tính lại tổng khi có thay đổi
                        });
                    });
            });
        </script>
        <script>
            function calculateTotal() {
                let total = 0;
                const quantityInputs = document.querySelectorAll(
                    'input[name="quantity[]"]'
                );
                const priceInputs = document.querySelectorAll(
                    'input[name="price[]"]'
                );
                const categoryInputs = document.querySelectorAll(
                    'input[name="category[]"]'
                );
                const totalInput = document.getElementById("total");

                for (let i = 0; i < quantityInputs.length; i++) {
                    const quantity = parseInt(quantityInputs[i].value) || 0;
                    const price = parseFloat(priceInputs[i].value) || 0;
                    total += quantity * price;
                }

                totalInput.value = total.toFixed(2);
                calculateRemaining();
            }

            function calculateRemaining() {
                const total =
                    parseFloat(document.getElementById("total").value) || 0;
                const paid =
                    parseFloat(document.getElementById("paid").value) || 0;
                const remaining = paid - total;
                document.getElementById("remaining").value =
                    remaining.toFixed(2);
            }

            function updatePriceAndCategory() {
                const bookSelects = document.querySelectorAll(".book-select");
                bookSelects.forEach((select, index) => {
                    select.addEventListener("change", function () {
                        const bookId = select.value;
                        const priceInput = document.querySelectorAll(
                            'input[name="price[]"]'
                        )[index];
                        const categoryInput = document.querySelectorAll(
                            'input[name="category[]"]'
                        )[index];

                        // Find book details from the books array and set the price and category
                        const selectedBook = books.find(
                            (book) => book[0] == bookId
                        );
                        if (selectedBook) {
                            priceInput.value = selectedBook[2]; // Assuming book[2] is the price
                            categoryInput.value = selectedBook[3]; // Assuming book[3] is the category
                        }

                        calculateTotal();
                    });
                });
            }

            // Add row functionality
            document
                .getElementById("add-row")
                .addEventListener("click", function () {
                    const tableBody = document.querySelector(
                        "#invoice-table tbody"
                    );
                    const newRow = document.createElement("tr");
                    newRow.innerHTML = `
                    <td>${tableBody.children.length + 1}</td>
                    <td>
                        <select name="bookID[]" class="book-select">
                            {% for book in books %}
                            <option value="{{ book[0] }}">{{ book[1] }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="text" name="category[]" readonly /></td>
                    <td><input type="number" name="quantity[]" min="1" onchange="calculateTotal()" /></td>
                    <td><input type="number" name="price[]" readonly /></td>
                `;
                    tableBody.appendChild(newRow);
                    updatePriceAndCategory(); // Rebind events after adding row
                });

            // Initialize price and category update for existing rows
            window.onload = function () {
                updatePriceAndCategory();
            };
        </script>
    </head>
    <body>
        <div class="invoice-form">
            <h2>Lập Hóa Đơn Bán Sách</h2>
            <form action="/create_invoice" method="POST" id="invoice-form">
                <label for="customer">Họ Tên Khách Hàng:</label>
                <select id="customer" name="customerName">
                    {% for customer in customers %}
                    <option value="{{ customer[0] }}">{{ customer[1] }}</option>
                    {% endfor %}
                </select>
    
                <label for="date">Ngày lập hóa đơn:</label>
                <input
                    type="date"
                    id="date"
                    name="date"
                    value="{{ today_date }}"
                    readonly
                />
    
                <table id="invoice-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Sách</th>
                            <th>Thể loại</th>
                            <th>Số lượng</th>
                            <th>Đơn giá</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>
                                <select name="bookID[]" class="book-select">
                                    {% for book in books %}
                                    <option value="{{ book[0] }}">
                                        {{ book[1] }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="text" name="category[]" readonly />
                            </td>
                            <td>
                                <input
                                    type="number"
                                    name="quantity[]"
                                    min="1"
                                    onchange="calculateTotal()"
                                />
                            </td>
                            <td>
                                <input type="number" name="price[]" readonly />
                            </td>
                        </tr>
                    </tbody>
                </table>
    
                <button type="button" id="add-row">Thêm Dòng</button>
                <br />
    
                <label for="total">Tổng tiền:</label>
                <input type="text" id="total" name="total" readonly />
    
                <label for="paid">Số tiền trả:</label>
                <input
                    type="text"
                    id="paid"
                    name="paid"
                    onchange="calculateRemaining()"
                />
    
                <label for="remaining">Còn lại:</label>
                <input type="text" id="remaining" name="remaining" readonly />
    
                <!-- Nút Lưu Hóa Đơn -->
                <button type="submit" id="save-invoice">Lưu Hóa Đơn</button>
    
                <!-- Nút Xuất Hóa Đơn -->
                <button type="button" id="show-invoice" onclick="exportInvoice()">Xuất Hóa Đơn</button>
            </form>
        </div>
        <script>
            function exportInvoice() {
                const formData = new FormData(document.getElementById("invoice-form"));
        
                fetch("/export_invoice", {
                    method: "POST",
                    body: formData,
                })
                .then((response) => response.blob())
                .then((blob) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.style.display = "none";
                    a.href = url;
                    a.download = "invoice.docx";
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch((error) => console.error("Error exporting invoice:", error));
            }
        </script>
    
    </body>
    


<style>
    /* Thiết lập nền và kiểu cho toàn bộ trang */
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
    }

    /* Tạo không gian cho form */
    .invoice-form {
        max-width: 800px;
        margin: 30px auto;
        padding: 20px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Tiêu đề */
    h2 {
        text-align: center;
        color: #eb4800;
        font-size: 24px;
    }

    /* Các nhãn */
    label {
        font-weight: bold;
        color: #333333;
        margin-top: 10px;
        display: block;
    }

    /* Các trường nhập liệu */
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
    }

    /* Các trường nhập liệu chỉ đọc */
    input[readonly] {
        background-color: #f1f1f1;
    }

    /* Các nút bấm */
    button {
        background-color: #eb4800;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    /* Hiệu ứng khi hover trên các nút */
    button:hover {
        background-color: #c84a00;
    }

    /* Bảng chi tiết hóa đơn */
    #invoice-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    #invoice-table th,
    #invoice-table td {
        padding: 10px;
        border: 1px solid #ccc;
        text-align: center;
    }

    #invoice-table th {
        background-color: #f9f9f9;
        color: #333;
    }

    #invoice-table input[type="number"],
    #invoice-table select {
        width: 100%;
        padding: 5px;
        margin: 5px 0;
    }

    /* Các trường nhập liệu của tổng tiền và tiền còn lại */
    #total,
    #remaining,
    #paid {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        background-color: #f1f1f1;
    }

    /* Hiển thị nút thêm dòng */
    #add-row {
        background-color: #eb4800;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-top: 10px;
    }

    #add-row:hover {
        background-color: #c84a00;
    }

    /* Điều chỉnh khoảng cách cho form */
    form {
        padding: 20px;
    }

    /* Đảm bảo các trường nhập liệu và nút bấm có đủ khoảng cách */
    form label,
    form input,
    form button {
        margin-bottom: 15px;
    }

    /* Tạo khoảng cách giữa các phần */
    br {
        margin-bottom: 15px;
    }

    /* Cột thứ 2 (Sách) */
    /* Điều chỉnh độ rộng của input trong cột "Thể loại" */
    #invoice-table td input[type="text"] {
        width: 100px; /* Giới hạn độ rộng của input */
        padding: 5px;
        font-size: 14px; /* Tùy chọn để điều chỉnh kích thước văn bản */
    }
</style>
    </body>
</html>
